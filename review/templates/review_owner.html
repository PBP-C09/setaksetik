{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Setak Setik</title>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
<div class="overflow-x-hidden px-4 md:px-8 pb-8 pt-24 min-h-screen bg-[#5B3E39] flex flex-col">
  <div class="p-2 mb-2 relative">
    <h1 class="text-[52px] text-4xl font-reguler text-[#F5F5DC] text-center">
      Apa kata, <span class="italic">mereka</span>?
    </h1>
    <hr class="border-t-2 border-[#F5F5DC] my-6 w-[460px] mx-auto" />
    <p class="text-center text-[#F5F5DC]">Dengar cerita dan rekomendasi dari steak<br>enthusiasts di seluruh penjuru</p>
  </div>

  <div id="review_entry_cards"></div>
</div>

<script>
  async function getReviewEntries() {
    return fetch("{% url 'review:show_json' %}").then((res) => res.json())
  }

  async function submitReply(reviewId, inputElement) {
    const replyText = inputElement.value.trim();
    console.log("ini reply text " + replyText)
    if (!replyText) return;

    try {
      const response = await fetch("{% url 'review:submit_reply' %}", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({
          review_id: reviewId,
          reply_text: replyText
        })
      });
      console.log("respon nya ok gasi " + response.ok)
      if (response.ok) {
        // Clear input and refresh reviews
        inputElement.value = '';
        refreshReviewEntries();
      } else {
        const data = await response.json();
        alert(data.message || 'Error submitting reply');
      }
    } catch (error) {
      console.error("Error submitting reply:", error);
      alert('Error submitting reply');
    }
  }

  async function refreshReviewEntries() {
    const reviewContainer = document.getElementById("review_entry_cards");
    reviewContainer.innerHTML = "";
    
    const reviews = await getReviewEntries();
    
    const html = `
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full">
        ${reviews.map(review => `
          <div class="bg-[#F5F5DC] shadow-lg rounded-lg overflow-hidden">
            <div class="p-4">
              <h3 class="font-bold text-xl text-[#5B3E39] mb-2">${DOMPurify.sanitize(review.fields.menu)}</h3>
              
              <div class="flex items-center space-x-2 mb-2">
                <i class="fas fa-map-marker-alt text-[#5B3E39]"></i>
                <p class="text-base font-semibold text-[#5B3E39]">${DOMPurify.sanitize(review.fields.place)}</p>
              </div>

              <div class="flex items-center space-x-2 mb-2">
                <i class="fas fa-star text-yellow-400"></i>
                <p class="text-base font-semibold text-[#5B3E39]">${review.fields.rating} / 5</p>
              </div>
              
              <p class="text-gray-600 mb-4">${DOMPurify.sanitize(review.fields.description)}</p>
              
              <div class="mt-4 border-t pt-4">
                ${review.fields.owner_reply ? `
                  <div class="bg-white p-3 rounded-lg">
                    <p class="text-sm font-semibold text-[#5B3E39]">Balasan pemilik:</p>
                    <p class="text-sm text-gray-600">${DOMPurify.sanitize(review.fields.owner_reply)}</p>
                  </div>
                ` : `
                  <div class="flex items-center space-x-2">
                    <input 
                      type="text" 
                      class="flex-1 p-2 border rounded-l-lg focus:outline-none focus:border-[#F7B32B]" 
                      placeholder="Ketik balasan Anda..."
                      id="reply-${review.pk}"
                    >
                    <button 
                      onclick="submitReply('${review.pk}', document.getElementById('reply-${review.pk}'))"
                      class="bg-[#F7B32B] text-white p-2 rounded-r-lg hover:bg-[#F7A52B] transition-colors duration-200"
                    >
                      <i class="fas fa-paper-plane"></i>
                    </button>
                  </div>
                `}
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
    
    reviewContainer.innerHTML = html;
  }

  // Initial load
  refreshReviewEntries();

  const modal = document.getElementById('crudModal');
  const modalContent = document.getElementById('crudModalContent');

  function showModal() {
    console.log("HELLO");

    const modal = document.getElementById('crudModal');
    const modalContent = document.getElementById('crudModalContent');

    modal.classList.remove('hidden');
    setTimeout(() => {
      modalContent.classList.remove('opacity-0', 'scale-95');
      modalContent.classList.add('opacity-100', 'scale-100');
    }, 50);
  }

  function hideModal() {
    const modal = document.getElementById('crudModal');
    const modalContent = document.getElementById('crudModalContent');

    modalContent.classList.remove('opacity-100', 'scale-100');
    modalContent.classList.add('opacity-0', 'scale-95');

    setTimeout(() => {
      modal.classList.add('hidden');
    }, 150);
  }

  // document.getElementById("cancelButton").addEventListener("click", hideModal);
  // document.getElementById("closeModalBtn").addEventListener("click", hideModal);

  function addReviewEntry() {
    fetch("{% url 'review:create-review-entry-ajax' %}", {
      method: "POST",
      body: new FormData(document.querySelector('#ReviewEntryForm')),
    })
      .then(response => {

        console.log("masuk add");
        refreshReviewEntries()
        console.log("AKOWKOWKOWOK");
      }).catch(e => {
        console.log(e);
      })

    // document.getElementById("ReviewEntryForm").reset();
    document.querySelector("[data-modal-toggle='crudModal']").click();

    return false;
  }
  // document.getElementById("ReviewEntryForm").addEventListener("submit", (e) => {
  //   e.preventDefault();
  //   addReviewEntry();
  // })
</script>

{% endblock content %}